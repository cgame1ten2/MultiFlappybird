<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flocky Birds: Fair Play Edition</title>
    
    <!-- 1. Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- 2. Favicon -->
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABTSURBVDhPY/wPBAw4wTAlBqXYAYjiP1gUpZgQGwXEA0Y0xXBxNMcKGEVkTUwM6K4ZBaMCRhFZE0s0w8TRHCtgFJE1MTEw4ATDlBiUYgeA4j9YFKWY/wEa1h8V+D7/EwAAAABJRU5ErkJggg==">

    <style>
        /* 3. CSS Styling */
        body {
            margin: 0; padding: 0;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; background-color: #222;
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9); color: white;
            z-index: 10; text-align: center;
        }

        .hidden { display: none !important; }

        h1 { font-size: 24px; color: #f4d03f; text-shadow: 4px 4px #000; margin-bottom: 30px; }
        p { font-size: 12px; line-height: 1.8; color: #ccc; max-width: 600px; margin: 10px 20px; }
        
        button {
            background: #e74c3c; border: 4px solid #c0392b; color: white;
            padding: 15px 30px; font-family: 'Press Start 2P', cursive;
            font-size: 16px; cursor: pointer; margin: 10px; text-transform: uppercase;
        }
        button:hover { background: #ff5e4d; margin-top: 8px; margin-bottom: 12px; }
        button:active { background: #c0392b; }

        input {
            padding: 15px; font-family: 'Press Start 2P', cursive; text-align: center;
            font-size: 14px; border: 4px solid #fff; background: #000; color: #fff;
            width: 250px; margin-bottom: 20px; text-transform: uppercase;
        }

        table { border-collapse: collapse; margin: 20px; width: 80%; max-width: 600px; }
        th, td { border: 2px solid #555; padding: 10px; text-align: center; font-size: 12px; }
        th { background: #444; color: #f1c40f; }
        tr:nth-child(even) { background: #222; }

        #mobile-controller {
            background-color: #4ec0ca; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        #flap-btn {
            width: 80vw; height: 50vh; background: #f1c40f;
            border: 8px solid #f39c12; border-radius: 20px;
            font-size: 24px; color: #d35400;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        #flap-btn:active { background: #fff; transform: scale(0.98); }

        .exit-btn {
            position: absolute; top: 20px; right: 20px;
            padding: 10px; font-size: 10px; background: #555; border-color: #333;
        }

        .player-chip {
            display: inline-block; padding: 5px 10px; margin: 5px;
            border: 2px solid white; font-size: 10px;
        }
    </style>
</head>
<body>

    <!-- MENUS & SCREENS -->
    <div id="menu-screen" class="overlay">
        <h1>FLOCKY BIRDS</h1>
        <p>Fairness Update</p>
        <br>
        <button onclick="window.startHost()">HOST GAME (Desktop)</button>
        <button onclick="window.showJoinScreen()">JOIN GAME (Mobile)</button>
    </div>

    <div id="join-screen" class="overlay hidden">
        <h1>CONNECT TO HOST</h1>
        <p>Enter the 4-character ID shown on the Host screen:</p>
        <input type="text" id="host-id-input" placeholder="ABCD" maxlength="4">
        <button onclick="window.connectToHost()">CONNECT</button>
        <br>
        <button style="background: #555; border-color: #333; font-size: 10px;" onclick="location.reload()">BACK</button>
    </div>

    <div id="lobby-screen" class="overlay hidden">
        <h1>LOBBY</h1>
        <p>Game ID:</p>
        <h2 id="display-id" style="font-size: 40px; color: #333; background: #fff; padding: 10px;">...</h2>
        <div id="player-list" style="margin: 20px; min-height: 50px;"></div>
        <p style="color: #e74c3c; font-size: 10px;">Waiting for players...</p>
        <button onclick="window.requestReadyCheck()">START READY CHECK</button>
    </div>

    <div id="ready-screen" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
        <h1 style="color: #fff;">GET READY</h1>
        <p>Everyone must JUMP to start</p>
        <div id="ready-status"></div>
    </div>

    <div id="mobile-ui" class="overlay hidden">
        <div id="mobile-controller">
            <button class="exit-btn" onclick="window.disconnectMobile()">EXIT</button>
            <h2 style="color: white; text-shadow: 2px 2px #000;">CONTROLLER</h2>
            <div id="mobile-status" style="margin-bottom: 20px; font-size: 10px;">Connected!</div>
            <button id="flap-btn" ontouchstart="window.sendJump(event)" onmousedown="window.sendJump(event)">FLAP!</button>
        </div>
    </div>

    <div id="game-over-screen" class="overlay hidden">
        <h1 style="color: #e74c3c;">GAME OVER</h1>
        <div id="leaderboard-container"></div>
        <br>
        <button onclick="window.resetGameFromUI()">PLAY AGAIN</button>
        <button onclick="location.reload()">MAIN MENU</button>
    </div>

    <div id="game-container"></div>

    <script>
        /**
         * GLOBAL CONFIG
         */
        let MODE = 'MENU'; 
        let GAME_STATE = 'LOBBY'; 
        
        let peer, conn;
        let birds = [];
        let pipes = [];
        let score = 0;
        let lastJumpTime = 0;
        
        // --- LATENCY EQUALIZATION SYSTEM ---
        let mobileLatencyMap = {}; // Map of peerId -> latency in ms
        let currentFairnessDelay = 0; // The calculated delay applied to keyboard players
        const LATENCY_BUFFER = 10; // Extra safety buffer in ms

        // HTML Hook Functions
        window.startHost = null; 
        window.connectToHost = null;
        window.sendJump = null;
        window.requestReadyCheck = null;
        window.resetGameFromUI = null;
        window.disconnectMobile = null;
        
        window.showJoinScreen = () => {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('join-screen').classList.remove('hidden');
        };

        const COLORS = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];

        function generateShortID() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        /**
         * P5.JS SKETCH (Host Logic)
         */
        const s = (p) => {

            let groundX = 0;
            let frameCountInternal = 0;
            let deadCount = 0;

            p.setup = () => {
                p.createCanvas(800, 600);
                p.noSmooth();
            };

            p.draw = () => {
                if (MODE !== 'HOST') return;

                drawBackground(p);

                if (GAME_STATE === 'LOBBY') {
                    drawGround(p);
                } 
                else if (GAME_STATE === 'READY') {
                    drawGround(p);
                    drawBirds(p); 
                    updateHover();
                }
                else if (GAME_STATE === 'PLAY') {
                    updatePhysics();
                    drawPipes(p);
                    drawGround(p);
                    drawBirds(p);
                    drawUI(p);
                    
                    // Debug Latency info
                    if (currentFairnessDelay > 0) {
                        p.fill(0, 200);
                        p.noStroke();
                        p.rect(0, p.height-20, 200, 20);
                        p.fill('#0f0');
                        p.textSize(10);
                        p.textAlign(p.LEFT);
                        p.text(`FAIRNESS DELAY: ${Math.floor(currentFairnessDelay)}ms`, 10, p.height - 7);
                    }
                } 
                else if (GAME_STATE === 'GAMEOVER') {
                    drawPipes(p);
                    drawGround(p);
                    drawBirds(p);
                }
            };

            // --- INPUT HANDLING WITH FAIRNESS DELAY ---
            p.keyPressed = () => {
                if (MODE !== 'HOST') return;

                const hasMobile = birds.some(b => b.controlType === 'mobile');
                const delay = hasMobile ? currentFairnessDelay : 0;

                // WRAP LOGIC IN DELAY FUNCTION
                const executeInput = () => {
                    // LOBBY
                    if (GAME_STATE === 'LOBBY') {
                        if (p.keyCode === 13 || p.keyCode === 27 || p.keyCode === 18) return; 
                        addPlayer('keyboard', p.key.toUpperCase(), null);
                    }
                    // READY
                    else if (GAME_STATE === 'READY') {
                        birds.forEach(b => {
                            if (b.controlType === 'keyboard' && b.controlKey === p.key.toUpperCase()) {
                                b.isReady = true;
                                checkAllReady();
                            }
                        });
                    }
                    // PLAY
                    else if (GAME_STATE === 'PLAY') {
                        birds.forEach(b => {
                            if (b.controlType === 'keyboard' && b.controlKey === p.key.toUpperCase() && !b.dead) {
                                b.flap();
                            }
                        });
                    }
                };

                // Apply Delay or Execute Immediately
                if (delay > 5) {
                    setTimeout(executeInput, delay);
                } else {
                    executeInput();
                }
            };

            // --- CORE LOGIC ---

            window.startHost = () => {
                MODE = 'HOST';
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('lobby-screen').classList.remove('hidden');

                const shortID = generateShortID();
                document.getElementById('display-id').innerText = shortID;
                
                peer = new Peer('flocky-' + shortID);
                peer.on('open', (id) => {
                    // Start the Latency Ping Loop
                    setInterval(pingLoop, 1000);
                });

                peer.on('connection', (c) => {
                    c.on('open', () => {
                        addPlayer('mobile', null, c);
                        sendToMobile(c, 'WAITING', 'LOBBY...');
                    });
                    c.on('data', (data) => {
                        if (data.type === 'JUMP') handleJumpSignal(c.peer);
                        if (data.type === 'PONG') handlePong(c.peer, data.ts);
                    });
                    c.on('close', () => removePlayer(c.peer));
                });
            };

            // --- LATENCY CALCULATION ---
            function pingLoop() {
                // Send Ping to all connected mobiles
                const now = Date.now();
                birds.forEach(b => {
                    if (b.controlType === 'mobile' && b.connection) {
                        b.connection.send({ type: 'PING', ts: now });
                    }
                });

                // Update global delay based on max latency found
                const latencies = Object.values(mobileLatencyMap);
                if (latencies.length > 0) {
                    const maxLatency = Math.max(...latencies);
                    // Smooth average could be better, but Max ensures total fairness
                    currentFairnessDelay = maxLatency + LATENCY_BUFFER;
                } else {
                    currentFairnessDelay = 0;
                }
            }

            function handlePong(peerId, originalTs) {
                const now = Date.now();
                const rtt = now - originalTs;
                const oneWay = rtt / 2;
                mobileLatencyMap[peerId] = oneWay;
            }

            function sendToMobile(conn, status, btnText) {
                if(conn && conn.open) {
                    conn.send({ type: 'STATUS', status: status, btn: btnText });
                }
            }

            function addPlayer(type, key, connection) {
                if (type === 'keyboard' && birds.find(b => b.controlType === 'keyboard' && b.controlKey === key)) return;
                if (type === 'mobile' && birds.find(b => b.controlType === 'mobile' && b.connId === connection.peer)) return;

                const id = birds.length + 1;
                const color = COLORS[birds.length % COLORS.length];
                const newBird = new Bird(id, color, type, key, connection ? connection.peer : null, p);
                if(connection) newBird.connection = connection;

                birds.push(newBird);
                updateLobbyUI();
            }

            function removePlayer(connId) {
                birds = birds.filter(b => b.connId !== connId);
                delete mobileLatencyMap[connId]; // Remove from latency calc
                updateLobbyUI();
            }

            function updateLobbyUI() {
                const list = document.getElementById('player-list');
                list.innerHTML = '';
                birds.forEach(b => {
                    const chip = document.createElement('div');
                    chip.className = 'player-chip';
                    chip.style.background = b.color;
                    chip.innerText = b.getName();
                    list.appendChild(chip);
                });
            }

            window.requestReadyCheck = () => {
                if (birds.length === 0) { alert("Need players!"); return; }
                GAME_STATE = 'READY';
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.add('hidden');
                document.getElementById('ready-screen').classList.remove('hidden');
                
                birds.forEach(b => {
                    b.reset();
                    if(b.connection) sendToMobile(b.connection, 'READY CHECK', 'TAP TO READY');
                });
                checkAllReady();
            };

            function handleJumpSignal(peerId) {
                const bird = birds.find(b => b.connId === peerId);
                if (!bird) return;

                if (GAME_STATE === 'READY') {
                    if (!bird.isReady) {
                        bird.isReady = true;
                        if(bird.connection) sendToMobile(bird.connection, 'READY!', 'WAITING...');
                        checkAllReady();
                    }
                } else if (GAME_STATE === 'PLAY' && !bird.dead) {
                    bird.flap();
                }
            }

            function checkAllReady() {
                const statusDiv = document.getElementById('ready-status');
                statusDiv.innerHTML = '';
                let allReady = true;
                birds.forEach(b => {
                    const d = document.createElement('div');
                    d.style.color = b.color;
                    d.innerText = b.getName() + ": " + (b.isReady ? "READY" : "WAITING...");
                    statusDiv.appendChild(d);
                    if (!b.isReady) allReady = false;
                });

                if (allReady && birds.length > 0) {
                    setTimeout(() => {
                        document.getElementById('ready-screen').classList.add('hidden');
                        startPlay();
                    }, 500);
                }
            }

            function startPlay() {
                GAME_STATE = 'PLAY';
                score = 0;
                frameCountInternal = 0;
                deadCount = 0;
                pipes = [];
                pipes.push(new Pipe(p.width, p));
                birds.forEach(b => {
                    if(b.connection) sendToMobile(b.connection, 'GO!', 'FLAP!');
                });
            }

            window.resetGameFromUI = () => { window.requestReadyCheck(); }

            function updateHover() {
                birds.forEach(b => {
                    b.y = 300 + Math.sin(p.frameCount * 0.1) * 10;
                    b.angle = 0;
                });
                groundX = (groundX + 3) % 20;
            }

            function updatePhysics() {
                frameCountInternal++;
                if (frameCountInternal % 100 === 0) pipes.push(new Pipe(p.width, p));
                if (pipes.length > 0 && pipes[0].x < -pipes[0].w) pipes.shift();

                pipes.forEach(pipe => pipe.update());

                birds.forEach(bird => {
                    if (!bird.dead) {
                        bird.update();
                        if (bird.y + bird.radius >= p.height - 40 || bird.y - bird.radius <= 0) {
                            bird.die(score); deadCount++;
                        }
                        pipes.forEach(pipe => {
                            if (bird.checkCollision(pipe)) { bird.die(score); deadCount++; }
                        });
                    } else {
                         if (bird.y < p.height - 40 - bird.radius) {
                             bird.velocity += 0.8; bird.y += bird.velocity;
                        }
                    }
                });

                pipes.forEach(pipe => {
                    if (!pipe.passed && pipe.x + pipe.w < 100) {
                        score++; pipe.passed = true;
                    }
                });

                if (deadCount === birds.length) showLeaderboard();
            }

            function showLeaderboard() {
                GAME_STATE = 'GAMEOVER';
                const cont = document.getElementById('leaderboard-container');
                const screen = document.getElementById('game-over-screen');
                screen.classList.remove('hidden');

                const sorted = [...birds].sort((a, b) => b.finalScore - a.finalScore);
                let html = `<table><tr><th>RANK</th><th>PLAYER</th><th>SCORE</th></tr>`;
                sorted.forEach((b, index) => {
                    html += `<tr><td>${index + 1}</td><td style="color:${b.color}">${b.getName()}</td><td>${b.finalScore}</td></tr>`;
                });
                html += `</table>`;
                cont.innerHTML = html;
            }

            // --- DRAWING ---
            function drawBackground(p) {
                p.background('#70c5ce'); 
                p.fill(255); p.noStroke();
                let cloudX = (p.frameCount * 0.5) % p.width;
                p.rect(p.width - cloudX, p.height - 150, 100, 30);
                p.fill('#a3e063'); p.rect(0, p.height - 100, p.width, 100);
            }

            function drawGround(p) {
                p.fill('#ded895'); p.stroke('#555'); p.strokeWeight(2);
                p.rect(0, p.height - 40, p.width, 40);
                p.fill('#73bf2e'); p.noStroke(); p.rect(0, p.height - 40, p.width, 10);
                p.stroke('#555'); p.strokeWeight(2);
                p.line(0, p.height - 40, p.width, p.height - 40);
                if (GAME_STATE === 'PLAY') groundX = (groundX + 3) % 20;
                for (let i = -20; i < p.width; i+=20) {
                    p.line(i - groundX, p.height - 40, i - groundX - 10, p.height);
                }
            }

            function drawBirds(p) { birds.forEach(b => b.render()); }
            function drawPipes(p) { pipes.forEach(pi => pi.render()); }
            
            function drawUI(p) {
                p.textAlign(p.CENTER); p.textSize(40); p.stroke(0);
                p.strokeWeight(4); p.fill(255);
                p.text(score, p.width / 2, 80);
            }
        };

        new p5(s, 'game-container');


        /**
         * CONTROLLER (MOBILE) LOGIC
         */
        window.connectToHost = () => {
            const inputVal = document.getElementById('host-id-input').value.toUpperCase().trim();
            if (inputVal.length < 4) { alert("Please enter 4 characters"); return; }
            MODE = 'CONTROLLER';
            document.getElementById('join-screen').classList.add('hidden');
            document.getElementById('mobile-ui').classList.remove('hidden');
            peer = new Peer(); 
            peer.on('open', (id) => {
                conn = peer.connect('flocky-' + inputVal);
                conn.on('open', () => {
                    document.getElementById('mobile-status').innerText = "CONNECTED TO " + inputVal;
                    document.getElementById('mobile-status').style.color = "#2ecc71";
                });
                
                conn.on('data', (data) => {
                    // HANDLE PING
                    if (data.type === 'PING') {
                        conn.send({ type: 'PONG', ts: data.ts });
                    }
                    // HANDLE STATUS
                    if (data.type === 'STATUS') {
                        document.getElementById('mobile-status').innerText = data.status;
                        document.getElementById('flap-btn').innerText = data.btn;
                    }
                });
                
                conn.on('error', () => { alert("Connection Failed"); window.disconnectMobile(); });
                conn.on('close', () => { alert("Host Closed"); window.disconnectMobile(); });
            });
        };

        window.sendJump = (e) => {
            if(e) e.preventDefault(); 
            const now = Date.now();
            if (now - lastJumpTime < 150) return; 
            lastJumpTime = now;
            if (conn && conn.open) conn.send({ type: 'JUMP' });
        };

        window.disconnectMobile = () => {
            if (conn) conn.close();
            if (peer) peer.destroy();
            MODE = 'MENU';
            document.getElementById('mobile-ui').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            document.getElementById('host-id-input').value = "";
            document.getElementById('flap-btn').innerText = "FLAP!";
        };

        /**
         * CLASSES
         */
        class Bird {
            constructor(id, color, controlType, controlKey, connId, p) {
                this.id = id; this.color = color; this.controlType = controlType;
                this.controlKey = controlKey; this.connId = connId;
                this.connection = null; this.p = p; this.finalScore = 0;
                this.reset();
            }

            getName() { return this.controlType === 'keyboard' ? `KEY ${this.controlKey}` : `MOBILE P${this.id}`; }

            reset() {
                this.x = 100; this.y = 300; this.velocity = 0;
                this.gravity = 0.5; this.lift = -8; this.radius = 12;
                this.dead = false; this.angle = 0; this.isReady = false;
                this.finalScore = 0;
            }

            flap() { this.velocity = this.lift; this.angle = -25; }

            die(currentScore) {
                if(this.dead) return;
                this.dead = true; this.finalScore = currentScore; this.velocity = 0; 
                if(this.connection) sendToMobile(this.connection, 'DEAD', 'X_X');
            }

            update() {
                this.velocity += this.gravity; this.y += this.velocity;
                if (this.velocity < 0) this.angle = -25;
                else if (this.angle < 90) this.angle += 3;
            }

            checkCollision(pipe) {
                let bx = this.x - this.radius + 4;
                let by = this.y - this.radius + 4;
                let bw = (this.radius * 2) - 8;
                let bh = (this.radius * 2) - 8;
                if (bx < pipe.x + pipe.w && bx + bw > pipe.x && by < pipe.top && by + bh > 0) return true;
                if (bx < pipe.x + pipe.w && bx + bw > pipe.x && by + bh > pipe.bottom && by < this.p.height) return true;
                return false;
            }

            render() {
                this.p.push(); this.p.translate(this.x, this.y);
                if (this.dead) this.p.rotate(this.p.radians(90)); else this.p.rotate(this.p.radians(this.angle));
                this.p.stroke(0); this.p.strokeWeight(2); this.p.fill(this.color);
                this.p.ellipse(0, 0, this.radius * 2.4, this.radius * 2);
                this.p.fill(255); this.p.ellipse(6, -6, 10, 10);
                this.p.fill(0); this.p.ellipse(8, -6, 2, 2);
                this.p.fill(255); this.p.ellipse(-6, 2, 10, 6);
                this.p.fill('#f39c12'); this.p.ellipse(8, 4, 8, 6);
                this.p.pop();

                if (GAME_STATE === 'READY' && this.isReady) {
                    this.p.fill('#2ecc71'); this.p.noStroke(); this.p.ellipse(this.x, this.y - 30, 10, 10);
                }
                if (!this.dead) {
                    this.p.noStroke(); this.p.fill(255); this.p.textSize(10);
                    this.p.textAlign(this.p.CENTER);
                    let label = this.controlType === 'keyboard' ? this.controlKey : `P${this.id}`;
                    this.p.text(label, this.x, this.y - 20);
                }
            }
        }

        class Pipe {
            constructor(startX, p) {
                this.x = startX; this.p = p; this.w = 60; this.gap = 130; this.speed = 3; this.passed = false;
                let minPipe = 50; let maxPipe = p.height - 40 - this.gap - minPipe;
                this.top = Math.random() * (maxPipe - minPipe) + minPipe;
                this.bottom = this.top + this.gap;
            }
            update() { this.x -= this.speed; }
            render() {
                this.p.stroke(0); this.p.strokeWeight(2); this.p.fill('#73bf2e');
                this.p.rect(this.x, 0, this.w, this.top);
                this.p.rect(this.x - 2, this.top - 20, this.w + 4, 20);
                this.p.rect(this.x, this.bottom, this.w, this.p.height - this.bottom - 40);
                this.p.rect(this.x - 2, this.bottom, this.w + 4, 20);
            }
        }
    </script>
</body>
</html>
